generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model Buyer {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  password      String   // Hashed password using bcryptjs
  fullName      String
  phone         String
  address       String?
  city          String?
  state         String?
  postalCode    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLogin     DateTime?
  isActive      Boolean  @default(true)
  
  invoices      Invoice[]
  orders        Order[]
  
  @@map("buyers")
}

model Invoice {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceNumber     String   @unique
  orderNumber       String   @unique
  
  buyerId           String?  @db.ObjectId
  buyer             Buyer?   @relation(fields: [buyerId], references: [id], onDelete: SetNull)
  
  customerName      String
  customerEmail     String
  customerPhone     String
  customerAddress   String?
  customerCity      String?
  customerState     String?
  customerPostalCode String?
  
  subtotal          Float
  shippingCost      Float
  taxAmount         Float
  totalAmount       Float
  
  items             InvoiceItem[]
  invoiceDate       DateTime @default(now())
  
  @@index([buyerId])
  @@map("invoices")
}

model InvoiceItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId     String   @db.ObjectId
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  productId     String
  name          String
  quantity      Int
  price         Float
  mode          String   // "buy" or "rent"
  
  @@map("invoice_items")
}

model Product {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String
  sellPrice         Float
  rentPrice         Float    @default(0)
  category          String
  badge             String?
  imageUrl          String   // Main Cloudinary URL
  imageUrls         String[] // Array of Cloudinary URLs
  
  sizes             String?
  color             String?
  material          String?
  condition         String?
  careInstructions  String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  orderItems        OrderItem[]

  @@index([category])
  @@map("products")
}

model Order {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber       String   @unique
  
  buyerId           String?  @db.ObjectId
  buyer             Buyer?   @relation(fields: [buyerId], references: [id], onDelete: SetNull)
  
  firstName         String
  lastName          String
  email             String
  phone             String?
  address           String?
  busStop           String?
  city              String?
  state             String?
  zipCode           String?
  country           String
  
  shippingType      String
  shippingCost      Float     @default(0)
  subtotal          Float
  total             Float
  paymentMethod     String
  status            String    @default("confirmed")
  
  items             OrderItem[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([buyerId])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String  @db.ObjectId
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  
  name        String
  quantity    Int
  price       Float
  rentPrice   Float?
  mode        String
  selectedSize String?
  rentalDays  Int     @default(0)
  
  @@map("order_items")
}

model Cart {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  sessionId   String  @unique
  
  items       CartItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("carts")
}

model CartItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  cartId    String  @db.ObjectId
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId String
  name      String
  quantity  Int
  price     Float
  rentPrice Float?
  mode      String
  selectedSize String?
  rentalDays Int @default(0)
  image     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cart_items")
}

model ErrorLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type      String
  message   String
  stack     String?
  context   String?
  userAgent String?
  url       String?
  timestamp DateTime @default(now())
  
  @@index([type])
  @@index([timestamp])
  @@map("error_logs")
}
