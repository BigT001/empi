#!/bin/bash
# EXECUTION GUIDE: Sales vs Rentals Categorization Fix
# 
# This script walks you through deploying and verifying the fix

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ SALES vs RENTALS CATEGORIZATION FIX"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "ğŸ“‹ FILES MODIFIED:"
echo "  âœ“ lib/models/Order.ts - Added 'orderType' field"
echo "  âœ“ app/api/orders/route.ts - Set orderType on order creation"
echo "  âœ“ app/api/admin/analytics/route.ts - Fixed sales/rental categorization"
echo ""

echo "ğŸ“ NEW FILES CREATED:"
echo "  âœ“ migrate-order-types.js - Migration script for existing orders"
echo "  âœ“ SALES_VS_RENTALS_FIX.md - Technical documentation"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ DEPLOYMENT STEPS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "STEP 1: Deploy code changes"
echo "  Command: git commit && git push (or deploy to production)"
echo "  Status: âœ… Ready - all changes are backward compatible"
echo ""

echo "STEP 2: Run migration to update existing orders"
echo "  Command: npx ts-node migrate-order-types.js"
echo "  Purpose: Analyzes all orders and assigns correct orderType"
echo "  Time: ~1-5 seconds depending on order count"
echo "  Safety: Creates no new records, only updates existing orders"
echo ""

echo "STEP 3: Verify in admin dashboard"
echo "  1. Log in as Super Admin or Finance Admin"
echo "  2. Go to Dashboard > Analytics"
echo "  3. Check Sales Revenue and Rental Revenue metrics"
echo "  4. Sales orders should appear under 'Sales Revenue'"
echo "  5. Rental orders should appear under 'Rental Revenue'"
echo "  6. Mixed orders count toward BOTH metrics"
echo ""

echo "STEP 4: Test with new orders"
echo "  Test 1: Create a SALES order (buy only)"
echo "    â†’ Should appear in 'Sales Revenue' metric"
echo "  Test 2: Create a RENTAL order (rent only)"
echo "    â†’ Should appear in 'Rental Revenue' metric"
echo "    â†’ Caution fee should be tracked separately"
echo "  Test 3: Create MIXED order (buy + rent)"
echo "    â†’ Sales revenue counts toward Sales"
echo "    â†’ Rental revenue counts toward Rental"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š WHAT'S FIXED:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ BEFORE:"
echo "  â€¢ All orders recorded as 'Rentals' regardless of type"
echo "  â€¢ Dashboard showed incorrect metric distribution"
echo "  â€¢ Couldn't distinguish sales from rental revenue"
echo ""
echo "âœ… AFTER:"
echo "  â€¢ Orders correctly categorized by type"
echo "  â€¢ Dashboard shows accurate Sales vs Rental split"
echo "  â€¢ Mixed orders counted correctly in both categories"
echo "  â€¢ Revenue calculated at item level, not order level"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”‘ KEY TECHNICAL DETAILS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Order Type Determination:"
echo "  â€¢ orderType = 'rental'  â† Only rental items"
echo "  â€¢ orderType = 'sales'   â† Only sales items"
echo "  â€¢ orderType = 'mixed'   â† Both rental AND sales items"
echo ""
echo "Revenue Calculation:"
echo "  â€¢ Per-item basis (NOT per-order)"
echo "  â€¢ Each item â†’ revenue goes to correct category (Sales or Rental)"
echo "  â€¢ Mixed orders contribute to BOTH totals"
echo ""
echo "Database Changes:"
echo "  â€¢ Added 'orderType' field to Order schema"
echo "  â€¢ Added index on orderType for fast filtering"
echo "  â€¢ Backward compatible - old orders still work"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ ALL SYSTEMS READY - DEPLOY WHEN READY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
